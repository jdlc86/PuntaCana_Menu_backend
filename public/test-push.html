<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Test Web Push</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, Arial; margin: 24px; max-width: 720px; }
      button { padding: 10px 14px; margin: 6px 6px 6px 0; }
      pre { background: #f5f5f5; padding: 12px; border-radius: 6px; overflow: auto; }
    </style>
  </head>
  <body>
    <h1>Prueba Web Push (backend)</h1>
    <p>1) Registra el Service Worker, 2) Permite notificaciones, 3) Suscríbete, 4) Desuscríbete.</p>

    <div>
      <button id="btn-register">1) Registrar SW</button>
      <button id="btn-permission">2) Pedir permiso</button>
      <button id="btn-subscribe">3) Suscribirme (enviar a /api/push/subscribe)</button>
      <button id="btn-unsubscribe">4) Desuscribirme (y POST /api/push/unsubscribe)</button>
    </div>

    <h3>Estado</h3>
    <pre id="out"></pre>

    <script>
      const VAPID_PUBLIC_KEY = "BLd_HHHyNZfuynzGXkyHW2MdbWmd8CFNOk5mFfQddaVO1pt7mM1taCZnTdDpUjSJF4konDzVFq1Up3Gjz5yIr-w"; // pega aquí tu pública (base64url)
      const OUT = document.getElementById("out");
      const log = (...a) => { OUT.textContent += a.join(" ") + "\n"; console.log(...a); };

      function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
        const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }

      let registration;

      document.getElementById("btn-register").onclick = async () => {
        if (!("serviceWorker" in navigator)) return log("SW no soportado en este navegador");
        registration = await navigator.serviceWorker.register("/sw-test.js");
        await navigator.serviceWorker.ready;
        log("Service Worker registrado y listo:", registration.scope);
      };

      document.getElementById("btn-permission").onclick = async () => {
        const res = await Notification.requestPermission();
        log("Permiso de notificación:", res);
      };

      document.getElementById("btn-subscribe").onclick = async () => {
        try {
          if (!registration) registration = await navigator.serviceWorker.ready;
          const sub = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
          });
          log("Subscription creada:", JSON.stringify(sub));
          // Enviar al backend
          const body = {
            endpoint: sub.endpoint,
            keys: { p256dh: sub.toJSON().keys.p256dh, auth: sub.toJSON().keys.auth },
            lang: navigator.language?.slice(0,2) || "es",
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "Europe/Madrid",
            user_agent: navigator.userAgent,
          };
          const r = await fetch("/api/push/subscribe", {
            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body)
          });
          log("POST /api/push/subscribe:", r.status, await r.text());
        } catch (e) {
          log("Error al suscribir:", e.message || e);
        }
      };

      document.getElementById("btn-unsubscribe").onclick = async () => {
        const reg = await navigator.serviceWorker.ready;
        const sub = await reg.pushManager.getSubscription();
        if (!sub) return log("No hay suscripción activa");
        const endpoint = sub.endpoint;
        const ok = await sub.unsubscribe();
        log("unsubscribe() del navegador:", ok);
        const r = await fetch("/api/push/unsubscribe", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ endpoint })
        });
        log("POST /api/push/unsubscribe:", r.status, await r.text());
      };
    </script>
  </body>
</html>
